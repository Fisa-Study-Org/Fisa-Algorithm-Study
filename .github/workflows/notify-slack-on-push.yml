name: Notify Slack on Push to main

on:
  push:
    branches: [main]

jobs:
  notify:
    runs-on: ubuntu-latest
    env:
      TZ: Asia/Seoul
    steps:
      - name: Get KST time
        run: echo "KST_NOW=$(date '+%Y-%m-%d %H:%M KST')" >> "$GITHUB_ENV"

      - name: Build message
        id: msg
        uses: actions/github-script@v7
        with:
          script: |
            const commits = context.payload.commits || [];
            const lines = commits.slice(0, 10).map(c => {
              const author = c.author?.username || c.author?.name || 'unknown';
              const title = (c.message || '').split('\n')[0];
              return `â€¢ ${title} â€” ${author}`;
            });
            core.setOutput('summary', lines.join('\n') || 'â€” (no commits captured) â€”');

      - name: Post to Slack
        uses: slackapi/slack-github-action@v1.27.0
        with:
          payload: |
            {
              "text": ":rocket: mainì— ë³€ê²½ì‚¬í•­ í‘¸ì‹œë¨",
              "blocks": [
                {
                  "type": "header",
                  "text": { "type": "plain_text", "text": "ğŸ“Œ main ë¸Œëœì¹˜ ì—…ë°ì´íŠ¸" }
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": ${{
                      toJSON(format("*ë¦¬í¬ì§€í† ë¦¬*: <{0}/{1}|{1}>\n*í‘¸ì‹œí•œ ìœ ì €*: {2}\n*ì‹œê°„(KST)*: {3}",
                        github.server_url, github.repository, github.actor, env.KST_NOW))
                    }}
                  }
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": ${{
                      toJSON(format("*ì»¤ë°‹ ìš”ì•½*:\n{0}", steps.msg.outputs.summary))
                    }}
                  }
                },
                { "type": "divider" },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "ğŸ”” *ë¡œì»¬/í¬í¬ ìµœì‹ í™”*\n```bash\ngit checkout main\ngit pull --rebase origin main\n# (í¬í¬)\ngit fetch upstream\ngit rebase upstream/main\n```"
                  }
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK
