name: Notify Slack on Push to main

on:
  push:
    branches: [main]

jobs:
  notify:
    runs-on: ubuntu-latest
    env:
      TZ: Asia/Seoul
    steps:
      - name: Get KST time
        run: echo "KST_NOW=$(date '+%Y-%m-%d %H:%M KST')" >> $GITHUB_ENV

      - name: Build message
        id: msg
        uses: actions/github-script@v7
        with:
          script: |
            const commits = context.payload.commits || [];
            // í•´ì‹œ ë¹¼ê³  ë©”ì‹œì§€ + ì‘ì„±ìë§Œ ì¶œë ¥
            const lines = commits
              .slice(0, 10)
              .map(c => `â€¢ ${c.message.split('\n')[0]} â€” ${c.author?.username || c.author?.name}`);
            core.setOutput('summary', lines.join('\n') || 'â€”');

      - name: Post to Slack
        uses: slackapi/slack-github-action@v1.27.0
        with:
          payload: |
            {
              "text": ":rocket: *mainì— ë³€ê²½ì‚¬í•­ í‘¸ì‹œë¨*",
              "blocks": [
                { "type": "header", "text": { "type": "plain_text", "text": "ğŸ“Œ main ë¸Œëœì¹˜ ì—…ë°ì´íŠ¸" } },
                { "type": "section", "text": { "type": "mrkdwn", "text": "*ë¦¬í¬ì§€í† ë¦¬*: <${{ github.server_url }}/${{ github.repository }}|${{ github.repository }}>\n*í‘¸ì‹œí•œ ìœ ì €*: ${{ github.actor }}\n*ì‹œê°„(KST)*: ${{ env.KST_NOW }}" } },
                { "type": "section", "text": { "type": "mrkdwn", "text": "*ì»¤ë°‹ ìš”ì•½*:\n${{ steps.msg.outputs.summary }}" } },
                { "type": "divider" },
                { "type": "section",
                  "text": { "type": "mrkdwn", "text": ":bell: *ë¡œì»¬/í¬í¬ ìµœì‹ í™”*\n```bash\ngit checkout main\ngit pull --rebase origin main\n# (í¬í¬)\ngit fetch upstream\ngit rebase upstream/main\n```" }
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK
